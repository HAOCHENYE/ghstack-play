name: Claude Code Merge Stack

on:
  issue_comment:
    types: [created]

jobs:
  merge-stack:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude merge')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install ghstack
        run: pip install ghstack

      - name: Run Claude Code for Stack Merge
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.issue.number }}
            COMMENT: ${{ github.event.comment.body }}
            AUTHOR: ${{ github.event.comment.user.login }}

            The user has requested to merge a ghstack-based stacked PR by commenting "@claude merge".

            IMPORTANT: Ghstack PRs structure:
            - Each PR has THREE branches: gh/*/head, gh/*/base, and gh/*/orig
            - ONLY gh/*/orig contains the single commit for that PR
            - gh/*/head contains the accumulated commits from the entire stack
            - You must cherry-pick from gh/*/orig branches, NOT from gh/*/head

            Your task:
            1. **Gather context from the stacked PRs**:
               - Use `gh pr view ${{ github.event.issue.number }} --json title,body,headRefName,baseRefName,state,mergeable,mergeStateStatus,number` to get the top PR details
               - Check if this is a ghstack PR by examining:
                 * The head branch name (should match pattern gh/*/head)
                 * The PR body for "Stack from ghstack"
               - Parse the PR body to find all PRs in the stack (listed bottom-to-top)
               - For each PR in the stack:
                 * Use `gh pr view <number> --json title,body,headRefName`
                 * Extract the stack identifier from headRefName (e.g., gh/username/123/head -> username/123)
                 * The corresponding orig branch is: gh/username/123/orig
                 * Verify the PR is in a mergeable state

            2. **Create a new branch from main**:
               ```
               git config user.email "claude-bot@users.noreply.github.com"
               git config user.name "Claude Bot"
               git fetch origin main
               git checkout -b merge-stack-$(date +%s) origin/main
               ```

            3. **Cherry-pick commits from gh/*/orig branches**:
               - For each PR in the stack (from bottom to top):
                 * Fetch the orig branch: `git fetch origin gh/<identifier>/orig`
                 * Get the commit SHA from orig: `git rev-parse FETCH_HEAD`
                 * Cherry-pick the single commit: `git cherry-pick <commit-sha>`
                 * If conflicts occur, report the issue and stop
               - Important: Each gh/*/orig branch contains exactly ONE commit for that PR

            4. **Push the new branch**:
               ```
               git push origin merge-stack-<timestamp>
               ```

            5. **Provide a create-PR link**:
               - Post a comment on PR ${{ github.event.issue.number }} with:
                 * Summary: "I've created a merge branch with cherry-picked commits from this stack"
                 * List each PR and its commit that was cherry-picked (from gh/*/orig)
                 * Create PR link: `https://github.com/${{ github.repository }}/compare/main...merge-stack-<timestamp>?expand=1`
                 * Note: "After this PR is merged, I'll close the original stacked PRs and delete their gh/* branches"

            6. **Future cleanup** (for after manual merge of the new PR):
               - This can be done in a follow-up or manually
               - Close all PRs in the stack
               - Delete all gh/* branches (head, base, orig for each PR)

            Important notes:
            - DO NOT cherry-pick from gh/*/head - it contains accumulated commits
            - ONLY cherry-pick from gh/*/orig - it contains the single commit per PR
            - DO NOT push directly to main - create an intermediate branch for review
            - If any step fails, stop and report without making changes

          claude_args: |
            --max-turns 30
            --model claude-opus-4-6
            --allowedTools "Bash(git:*),Bash(gh:*),Read,Grep,Glob"

          allowed_non_write_users: "*"
          track_progress: false
